
CREATE OR REPLACE Procedure xxbcm_data_migration
AS
BEGIN

INSERT INTO XXBCM_ORDER_HDR (ORDER_REF, ORDER_DATE, SUPPLIER_NAME, ORDER_TOTAL_AMOUNT)
SELECT DISTINCT ORDER_REF ORIG_ORDER_REF, 
TO_DATE (ORDER_DATE, 'DD/MM/YYYY') ORDER_DATE, 
SUPPLIER_NAME, 
ORDER_TOTAL_AMOUNT 
FROM XXBCM_ORDER_MGT
WHERE ORDER_LINE_AMOUNT IS NULL AND ORDER_REF NOT IN (SELECT DISTINCT F2.ORDER_REF FROM XXBCM_ORDER_HDR F2);
COMMIT;


INSERT INTO XXBCM_ORDER_DET (ORDER_REF, ORDER_REF_SEQ, ORIG_ORDER_REF, ORDER_DESCRIPTION, ORDER_STATUS, ORDER_LINE_AMOUNT, INVOICE_REFERENCE)
SELECT DISTINCT 
SUBSTR (ORDER_REF, 1, INSTR (ORDER_REF, '-') - 1) ORDER_REF, 
SUBSTR (ORDER_REF, INSTR (ORDER_REF, '-') + 1) ORDER_REF_SEQ,
ORDER_REF ORIG_ORDER_REF, 
ORDER_DESCRIPTION, 
ORDER_STATUS, 
TO_NUMBER(REGEXP_REPLACE(REPLACE(REPLACE(REPLACE(order_line_amount, 'o', 0), 'S', 5),'I',1),'\,','')) order_line_amount, 
INVOICE_REFERENCE 
FROM XXBCM_ORDER_MGT 
WHERE ORDER_TOTAL_AMOUNT IS NULL AND ORDER_REF NOT IN (SELECT DISTINCT F2.ORIG_ORDER_REF FROM XXBCM_ORDER_DET F2);
COMMIT;

INSERT INTO XXBCM_ORDER_INV (INVOICE_REFERENCE, ORIG_ORDER_REF, ORDER_REF, INVOICE_DATE, INVOICE_STATUS, INVOICE_HOLD_REASON, INVOICE_AMOUNT, INVOICE_DESCRIPTION )
SELECT DISTINCT 
INVOICE_REFERENCE, 
ORDER_REF ORIG_ORDER_REF, 
SUBSTR (ORDER_REF, 1, INSTR (ORDER_REF, '-') - 1) ORDER_REF, 
TO_DATE (invoice_date, 'DD-MM-YYYY') INVOICE_DATE, 
INVOICE_STATUS, 
INVOICE_HOLD_REASON, 
TO_NUMBER(REGEXP_REPLACE(REPLACE(REPLACE(REPLACE(invoice_amount,'o',0),'S',5),'I',1),'\,',''))INVOICE_AMOUNT, 
INVOICE_DESCRIPTION 
FROM XXBCM_ORDER_MGT WHERE INVOICE_REFERENCE IS NOT NULL 
AND ORDER_REF||INVOICE_REFERENCE||TO_NUMBER(REGEXP_REPLACE(REPLACE(REPLACE(REPLACE(invoice_amount,'o',0),'S',5),'I',1),'\,',''))
NOT IN (SELECT DISTINCT ORIG_ORDER_REF||INVOICE_REFERENCE||INVOICE_AMOUNT FROM XXBCM_ORDER_INV);
COMMIT;


INSERT INTO XXBCM_SUPPLIER (SUPPLIER_NAME, SUPP_FIRST_NAME, SUPP_LAST_NAME, SUPP_CONTACT_NAME, SUPP_CONTACT_NUMBER1, SUPP_CONTACT_NUMBER2, SUPP_EMAIL)
SELECT DISTINCT 
SUPPLIER_NAME, 
TRIM(SUBSTR (SUPPLIER_NAME,1,INSTR (SUPPLIER_NAME, ' ') - 1)) SUPP_FIRST_NAME,
TRIM(SUBSTR(SUPPLIER_NAME,INSTR (SUPPLIER_NAME, ' ') + 1)) SUPP_LAST_NAME,
SUPP_CONTACT_NAME, 
TRIM(TO_NUMBER(REGEXP_REPLACE(REPLACE(REPLACE(REPLACE(TRIM(SUBSTR (SUPP_CONTACT_NUMBER,INSTR (SUPP_CONTACT_NUMBER, ',')
 + 1)),'o',0), 'S', 5),'I', 1),'\.| ', ''))) SUPP_CONTACT_NUMBER1,
REGEXP_REPLACE (
TRIM (SUBSTR (SUPP_CONTACT_NUMBER,1, INSTR (SUPP_CONTACT_NUMBER, ',') - 1)),'\.| ','')SUPP_CONTACT_NUMBER2, 
SUPP_EMAIL FROM XXBCM_ORDER_MGT
WHERE SUPPLIER_NAME NOT IN (SELECT DISTINCT SUPPLIER_NAME FROM XXBCM_SUPPLIER);
COMMIT;

EXCEPTION
WHEN OTHERS THEN
   raise_application_error(-20001,'An error was encountered - '||SQLCODE||' -ERROR- '||SQLERRM);
   
END;

execute xxbcm_data_migration;

CREATE OR REPLACE PROCEDURE XXBCM_ORDER_SUMMARY(cursor_ OUT SYS_REFCURSOR)
AS
BEGIN
OPEN cursor_ FOR
   SELECT  
TO_NUMBER(SUBSTR(F1.ORDER_REF,length(F1.ORDER_REF)-2,length(F1.ORDER_REF))) Order_Reference , 
TO_CHAR(ORDER_DATE, 'MON-YY') ORDER_PERIOD,
INITCAP(LOWER(F2.SUPP_FIRST_NAME))||' '||INITCAP(LOWER(F2.SUPP_LAST_NAME)) SUPPLIER_NAME,
TO_CHAR(ORDER_TOTAL_AMOUNT, '99,999,990.99') Order_Total_Amount,
ORDER_STATUS, F3.INVOICE_REFERENCE, TO_CHAR(INVOICE_AMOUNT, '99,999,990.99') INVOICE_TOTAL_AMOUNT,
DECODE(INVOICE_STATUS, 'Paid','OK','Pending','To follow up',null,'To verify') ACTION
FROM XXBCM_ORDER_HDR F1, XXBCM_SUPPLIER F2, XXBCM_ORDER_DET F3, XXBCM_ORDER_INV F4  
WHERE F1.SUPPLIER_NAME=F2.SUPPLIER_NAME 
AND F1.ORDER_REF=F3.ORDER_REF
AND F3.ORIG_ORDER_REF=F4.ORIG_ORDER_REF(+)
AND F3.INVOICE_REFERENCE=F4.INVOICE_REFERENCE(+)
AND F3.ORDER_LINE_AMOUNT=F4.INVOICE_AMOUNT(+)
order by ORDER_DATE desc;

EXCEPTION
WHEN OTHERS THEN
   raise_application_error(-20001,'An error was encountered - '||SQLCODE||' -ERROR- '||SQLERRM);
   
END;



CREATE OR REPLACE PROCEDURE XXBCM_3RD_HIGHEST_AMT(cursor_ OUT SYS_REFCURSOR)
AS
BEGIN
OPEN cursor_ FOR
SELECT ORDER_REFERENCE, ORDER_PERIOD, SUPPLIER_NAME, TO_CHAR(MAX(TO_NUMBER(ORDER_TOTAL_AMOUNT,'99,999,990.99')), '99,999,990.99') Order_Total_Amount, 
LISTAGG(INVOICE_REFERENCE, ', ') WITHIN GROUP (ORDER BY INVOICE_REFERENCE) INVOICE_REFERENCE  FROM (   
SELECT  
TO_NUMBER(SUBSTR(F1.ORDER_REF,length(F1.ORDER_REF)-2,length(F1.ORDER_REF))) Order_Reference , 
TO_CHAR(ORDER_DATE, 'Month DD, YYYY') ORDER_PERIOD,
TRIM(F1.SUPPLIER_NAME) SUPPLIER_NAME,
TO_CHAR(MAX(ORDER_TOTAL_AMOUNT), '99,999,990.99') Order_Total_Amount,
MAX(ORDER_STATUS), LISTAGG(F3.INVOICE_REFERENCE, ', ') WITHIN GROUP (ORDER BY F3.INVOICE_REFERENCE) INVOICE_REFERENCE
FROM XXBCM_ORDER_HDR F1, XXBCM_SUPPLIER F2, XXBCM_ORDER_DET F3, XXBCM_ORDER_INV F4  
WHERE F1.SUPPLIER_NAME=F2.SUPPLIER_NAME 
AND F1.ORDER_REF=F3.ORDER_REF
AND F3.ORIG_ORDER_REF=F4.ORIG_ORDER_REF(+)
AND F3.INVOICE_REFERENCE=F4.INVOICE_REFERENCE(+)
AND F3.ORDER_LINE_AMOUNT=F4.INVOICE_AMOUNT(+)
AND ORDER_STATUS != 'Cancelled'
AND F1.ORDER_REF||F1.ORDER_TOTAL_AMOUNT = 
(select min(order_ref||order_total_amount) from (select order_ref, rownum rnum, order_total_amount  
from (SELECT * FROM XXBCM_ORDER_HDR  ORDER BY ORDER_TOTAL_AMOUNT DESC ) r where rownum <= 3) WHERE rnum >= 3)
group by f1.ORDER_REF, ORDER_DATE, F1.SUPPLIER_NAME, ORDER_TOTAL_AMOUNT, F3.INVOICE_REFERENCE
order by ORDER_DATE desc )
GROUP BY ORDER_REFERENCE, ORDER_PERIOD, SUPPLIER_NAME;

EXCEPTION
WHEN OTHERS THEN
   raise_application_error(-20001,'An error was encountered - '||SQLCODE||' -ERROR- '||SQLERRM);
   
END;


CREATE OR REPLACE PROCEDURE XXBCM_SUPPLIER_SUMMARY(cursor_ OUT SYS_REFCURSOR)
AS
BEGIN
OPEN cursor_ FOR
 SELECT F1.SUPPLIER_NAME, SUPP_CONTACT_NAME, TRIM(to_char(SUPP_CONTACT_NUMBER1,'9999,9999')) Supplier_Contact_No_1,
  TRIM(to_char(SUPP_CONTACT_NUMBER2,'9999,9999')) Supplier_Contact_No_2, count(*) Total_Orders,  
TRIM(TO_CHAR( SUM(ORDER_TOTAL_AMOUNT), '99,999,990.99'))  Order_Total_Amount
FROM XXBCM_ORDER_HDR F1, XXBCM_SUPPLIER F2, XXBCM_ORDER_DET F3, XXBCM_ORDER_INV F4  
WHERE F1.SUPPLIER_NAME=F2.SUPPLIER_NAME 
AND F1.ORDER_REF=F3.ORDER_REF
AND F3.ORIG_ORDER_REF=F4.ORIG_ORDER_REF(+)
AND F3.INVOICE_REFERENCE=F4.INVOICE_REFERENCE(+)
AND F3.ORDER_LINE_AMOUNT=F4.INVOICE_AMOUNT(+)
AND ORDER_DATE >= TO_DATE('01 JANUARY 2017','DD/MM/YYYY')
AND ORDER_DATE <= TO_DATE('01 AUGUST 2017','DD/MM/YYYY')
group by F1.SUPPLIER_NAME, SUPP_CONTACT_NAME, SUPP_CONTACT_NUMBER1, SUPP_CONTACT_NUMBER2;

EXCEPTION
WHEN OTHERS THEN
   raise_application_error(-20001,'An error was encountered - '||SQLCODE||' -ERROR- '||SQLERRM);
   
END;


  